I"õ-<hr />

<p><em>Before following this tutorial, make sure youâ€™ve installed</em></p>

<ul>
  <li><em>Docker (<a href="https://www.docker.com/">https://www.docker.com/</a>)</em></li>
  <li><em>Metamask (<a href="https://www.docker.com/">https://metamask.io</a>)</em></li>
</ul>

<p><em>You will need a private-public key pair to register your service in SNET. Generate them in Metamask before you start this tutorial.</em></p>

<hr />

<p>Run this tutorial from a bash terminal.</p>

<p>Weâ€™ll use Java gRPC, for more details see https://grpc.io/docs/</p>

<p>In this tutorial weâ€™ll create a Java service and publish it in SingularityNET.</p>

<h2 id="step-1">Step 1</h2>

<p>Setup a <code class="highlighter-rouge">ubuntu:18.04</code> docker container (with proper <code class="highlighter-rouge">SNET Daemon</code> version) using provided <code class="highlighter-rouge">Dockerfile</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>SNETD_VERSION="v0.1.7"
docker build \
    --build-arg language=java \
    --build-arg snetd_version=$SNETD_VERSION \
    -t snet_java_service https://github.com/singnet/dev-portal.git#master:/tutorials/docker

ETCD_HOST=$HOME/.snet/etcd/example-java-service/
ETCD_CONTAINER=/opt/singnet/etcd/
docker run -p 7000:7000 -v $ETCD_HOST:$ETCD_CONTAINER -ti snet_java_service bash
</code></pre></div></div>

<p>From this point we follow the tutorial in the Docker containerâ€™s prompt.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cd dev-portal/tutorials/java
</code></pre></div></div>

<h2 id="step-2">Step 2</h2>

<p>Create the skeleton structure for your serviceâ€™s project</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./create_project.sh PROJECT_NAME ORGANIZATION_ID SERVICE_ID SERVICE_PORT
</code></pre></div></div>

<p><code class="highlighter-rouge">PROJECT_NAME</code> is a short tag for your project. It will be used to name
projectâ€™s directory and as a namespace tag in the .proto file.</p>

<p><code class="highlighter-rouge">ORGANIZATION_ID</code> is the id of an organization that you are a member or owner.</p>

<p><code class="highlighter-rouge">SERVICE_ID</code> is the id of your service.</p>

<p><code class="highlighter-rouge">SERVICE_PORT</code> is the port number (in localhost) the service will listen to.</p>

<p><code class="highlighter-rouge">create_project.sh</code> will create a directory named <code class="highlighter-rouge">PROJECT_NAME</code> with a basic
empty implementation of the service.</p>

<p>In this tutorial weâ€™ll implement a service with two methods:</p>

<ul>
  <li>int div(int a, int b)</li>
  <li>string check(int a)</li>
</ul>

<p>So weâ€™ll use this command line to create projectâ€™s skeleton</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./create_project.sh tutorial snet math-operations 7070
cd tutorial
</code></pre></div></div>

<h2 id="step-3">Step 3</h2>

<p>Now weâ€™ll customize the skeleton code to actually implement our basic service.
We need to edit <code class="highlighter-rouge">../howToWriteJavaService/tutorial/src/main/java/service_spec/tutorial.proto</code> and define</p>

<ul>
  <li>the data structures used to carry input and output of the methods, and</li>
  <li>the RPC API of the service.</li>
</ul>

<p>Take a look at https://developers.google.com/protocol-buffers/docs/overview to
understand everything you can do in the <code class="highlighter-rouge">.proto</code> file.</p>

<p>Edit the proto file:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>nano src/main/java/service_spec/tutorial.proto
</code></pre></div></div>

<p>In this tutorial our proto file should be like this:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>syntax = "proto3";

option java_generic_services = true;
option java_multiple_files = true;

message IntPair {
    int32 a = 1;
    int32 b = 2;
}

message SingleInt {
    int32 v = 1;
}

message SingleString {
    string s = 1;
}

service ServiceDefinition {
    rpc div(IntPair) returns (SingleInt) {}
    rpc check(SingleInt) returns (SingleString) {}
}
</code></pre></div></div>

<p>Each <code class="highlighter-rouge">message</code> statement define a data structure used either as input or output
in the API. The <code class="highlighter-rouge">service</code> statement defines the RPC API itself.</p>

<h2 id="step-4">Step 4</h2>

<p>In order to actually implement our API we need to edit the <code class="highlighter-rouge">JavaServer.java file</code>.</p>

<p>Look for <code class="highlighter-rouge">SERVICE_API</code> and replace <code class="highlighter-rouge">doSomething()</code> by our actual API methods:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
@Override
public void div(IntPair request, StreamObserver&lt;SingleInt&gt; responseObserver) {
    int result = request.getA() / request.getB();
    SingleInt reply = SingleInt.newBuilder().setV(result).build();
    responseObserver.onNext(reply);
    responseObserver.onCompleted();
}

</code></pre></div></div>
<h2 id="step-5">Step 5</h2>

<p>Now weâ€™ll write a client to test our server locally (without using the
blockchain). Edit <code class="highlighter-rouge">JavaClient.java</code>.</p>

<p>Look for <code class="highlighter-rouge">TEST_CODE</code> and replace <code class="highlighter-rouge">doSomething()</code> implementation by our
testing code:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public void div(int a, int b) {
    logger.info("Trying to divide "+a+" by "+ b);
    IntPair request = IntPair.newBuilder().setA(a).setB(b).build();
    SingleInt response;
    try {
        response = blockingStub.div(request);
        logger.log(Level.INFO, "Result: " + response.getV());
    } catch (StatusRuntimeException e) {
        logger.log(Level.WARNING, "RPC failed: {0}", e.getStatus());
        return;
    }
}

</code></pre></div></div>

<h2 id="step-6">Step 6</h2>

<p>To compile the protobuf and generate server and client jar:</p>

<p>Note 1: protobuf compile is embedded in the commands below. For more details, please edit build.sh.</p>

<p>Note 2: On you project name, used in the previous command <code class="highlighter-rouge">./create_project.sh</code></p>

<p>To generate a server application:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh build.sh tutorial server
</code></pre></div></div>

<p>To generate a client application:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sh build.sh tutorial client
</code></pre></div></div>

<h2 id="step-7">Step 7</h2>

<p>To test our server locally (without using the blockchain)</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -jar ./bin/JavaServer.jar &amp;
</code></pre></div></div>
<p>In a new terminal instance</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -jar ./bin/JavaClient.jar 12 4
</code></pre></div></div>

<p>You should have something like the following output:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>java -jar ./bin/JavaServer.jar &amp;

# [1] 1627
# Nov 18, 2018 5:27:16 AM JavaServer start
# INFO: Server listening on 7070

java -jar ./bin/JavaClient.jar 12 4

# Client connected on port: 7070
# Nov 18, 2018 5:30:13 AM JavaClient div
# INFO: Trying to div 12 by 4
# Nov 18, 2018 5:30:13 AM JavaClient div
</code></pre></div></div>

<p>At this point you have successfully built a gRPC Java service. The executables can 
be used from anywhere inside the container (they donâ€™t need anything from 
the installation directory) or outside the container.</p>

<p>The next steps in this tutorial will publish the service in SingularityNET.</p>

<h2 id="step-8">Step 8</h2>

<p>Now you must follow the <a href="https://dev.singularitynet.io/tutorials/publish/">publish</a>
tutorial to publish this service or use our script (next step).</p>

<p>Youâ€™ll also need a <code class="highlighter-rouge">SNET CLI</code> identity (check step 3 from <a href="https://dev.singularitynet.io/tutorials/publish/#step-3-setup-snet-cli-and-create-your-identity">publish</a> tutorial).</p>

<h2 id="step-9">Step 9</h2>

<p>First, make sure you killed the <code class="highlighter-rouge">server</code> process started in Step 7.</p>

<p>Then
publish and start your service:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./publishAndStartService.sh PAYMENT_ADDRESS
</code></pre></div></div>

<p>Replace <code class="highlighter-rouge">PAYMENT_ADDRESS</code> by your public key (wallet).</p>

<p>Example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./publishAndStartService.sh 0x501e8c58E6C16081c0AbCf80Ce2ABb6b3f91E717
</code></pre></div></div>

<p>This will start the <code class="highlighter-rouge">SNET Daemon</code> and your service. If everything goes well you will 
see the blockchain transaction logs and then the following messages 
(respectively from: your service and <code class="highlighter-rouge">SNET Daemon</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># [blockchain log]
# INFO: Server listening on 7070
# [daemon initial log]
# INFO[0002] Blockchain is enabled: instantiate payment validation interceptor 
# INFO[0002]                                               PaymentChannelStorageClient="&amp;{ConnectionTimeout:5s RequestTimeout:3s Endpoints:[http://127.0.0.1:2379]}"
# INFO[0002] Default payment handler registered            defaultPaymentType=escrow
# DEBU[0002] starting daemon                              
</code></pre></div></div>

<p>You can double check if it has been properly published using</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snet organization list-services snet
</code></pre></div></div>

<p>Optionally you can un-publish the service</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snet service delete snet math-operations
</code></pre></div></div>

<p>Actually, since this is just a tutorial, you are expected to un-publish your
service as soon as you finish the tests.</p>

<p>Other <code class="highlighter-rouge">snet</code> commands and options (as well as their documentation) can be found 
<a href="https://github.com/singnet/snet-cli">here</a>.</p>

<h2 id="step-10">Step 10</h2>

<p>You can test your service making requests in command line:</p>

<p>The <code class="highlighter-rouge">openChannel.sh</code> script will open and initialize a new payment channel, itâ€™ll 
output the new channel id (that will be used by <code class="highlighter-rouge">testServiceRequest.sh</code>):</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./openChannel.sh

# [blockchain log]
# #channel_id
# 10
</code></pre></div></div>

<p>In this example the channel id is <code class="highlighter-rouge">10</code>.</p>

<p>Now you can run <code class="highlighter-rouge">testServiceRequest.sh VALUE_A VALUE_B</code>:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./testServiceRequest.sh 12 4

# [blockchain log]
#   response:
#       v: 3
</code></pre></div></div>

<p>Thatâ€™s it. Remember to delete your service as explained in Step 9.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snet service delete snet math-operations
</code></pre></div></div>
:ET